#!/usr/bin/env bash
VERSION='v1.4.4'

# compatibility with Narada <1.2.0
[ -d ./var/patch/prev ] && mv ./var/patch/prev ./var/patch/.prev

exclude=( -x "\A./var/patch/" )
IFS=$'\n'
exclude+=( $(
    (find ./config/ -type f; cd ./var/patch/.prev/; find ./config/ -type f) |
    sort | uniq -c | grep '^ *2 ' | sed 's/^ *2 //' |
    perl -ne 'chomp; print "-x\n"; print "\\A\Q$_\E\\z\n"'
    ) )
IFS=$' \t\n'

powerdiff -o tmp/CURRENT -f config/patch/exclude "${exclude[@]}" \
    ./var/patch/.prev/ ./

rm                      var/patch/CURRENT.*            2>/dev/null
mv tmp/CURRENT.pre.sh   var/patch/CURRENT.10.sh        2>/dev/null
mv tmp/CURRENT.patch    var/patch/CURRENT.20.patch     2>/dev/null
mv tmp/CURRENT.tgz      var/patch/CURRENT.30.tgz       2>/dev/null
mv tmp/CURRENT.post.sh  var/patch/CURRENT.40.sh        2>/dev/null

exit
: <<'=cut'

=encoding utf8

=head1 NAME

narada-diff - prepare patch from previous version to current


=head1 VERSION

This document describes narada-diff version v1.4.4


=head1 USAGE

    narada-diff


=head1 DESCRIPTION

Script must be executed only from "project root directory".

When executed, script will delete C<var/patch/CURRENT.*> files, then
detect all changes between previous and current project versions and
generate from 0 (if there are no changes) to 4 files with these names:

    var/patch/CURRENT.10.sh
    var/patch/CURRENT.20.patch
    var/patch/CURRENT.30.tgz
    var/patch/CURRENT.40.sh

You should review these files - if something is wrong, then make changes
to project and run C<narada-diff> again until you'll be happy.

Next you can manually modify these files. If you need to add some commands
to .sh files - it's better to put them into C<var/patch/PENDING.*.sh>
instead of modifying these files. But if you need to remove some changes
from these files to avoid including them into next update - it's ok.

Now, run C<narada-release> to release next update with all changes from
current C<var/patch/CURRENT.*> and C<var/patch/PENDING.*> files.

When detecting changes it take in account C<config/patch/exclude> plus
handle files in C<config/> in special way: only added and removed files
processed, changed files ignored.


=head1 REQUIRED ARGUMENTS

None.


=head1 OPTIONS

See USAGE.


=head1 DIAGNOSTICS

None.


=head1 CONFIGURATION AND ENVIRONMENT

Use config/patch/exclude.
Use files in var/patch/.


=head1 DEPENDENCIES

None.


=head1 INCOMPATIBILITIES

None reported.


=head1 BUGS AND LIMITATIONS

No bugs have been reported.

Please report any bugs or feature requests to
C<bug-narada@rt.cpan.org>, or through the web interface at
L<http://rt.cpan.org>.


=head1 AUTHOR

Alex Efros C<< <powerman@cpan.org> >>


=head1 LICENSE AND COPYRIGHT

This software is Copyright (c) 2008-2015 by Alex Efros E<lt>powerman@cpan.orgE<gt>.

This is free software, licensed under:

  The MIT (X11) License


=cut
