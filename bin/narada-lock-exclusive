#!/usr/bin/perl
use warnings;
use strict;

our $VERSION = '1.3.15';

use FindBin;
use lib "$FindBin::Bin/../lib/perl5";
use Narada::Lock qw( exclusive_lock unlock_new );

local @ARGV = @ARGV ? @ARGV : ('env', 'PS1=[LOCKED] \u@\h \w \$ ', 'bash', '--norc');

exclusive_lock();
{ local $ENV{NARADA_SKIP_LOCK} = 1;
  system @ARGV;
}
unlock_new();
exit $? >> 8;   ## no critic (ProhibitMagicNumbers)


__END__

=encoding utf8

=head1 NAME

narada-lock-exclusive - run command under exclusive lock


=head1 VERSION

This document describes narada-lock-exclusive version v1.4.4


=head1 USAGE

    narada-lock-exclusive [/path/to/commands param ...]


=head1 DESCRIPTION

Wrapper for running other process under exclusive_lock().
Will also set environment variable NARADA_SKIP_LOCK to "1", so all scripts
executed under this wrapper will not try to set their own locks.

When executed without params will run `bash --norc` with '[LOCKED]' prefix
in $PS1.

Exit status of narada-lock-exclusive will be same as exit status of executed
command.

Script must be executed only from "project root directory".


=head1 REQUIRED ARGUMENTS

None.


=head1 OPTIONS

See USAGE.


=head1 DIAGNOSTICS

None.


=head1 CONFIGURATION AND ENVIRONMENT

Use var/.lock and var/.lock.new files.

Will set NARADA_SKIP_LOCK environment variable.


=head1 DEPENDENCIES

None.


=head1 INCOMPATIBILITIES

None reported.


=head1 BUGS AND LIMITATIONS

No bugs have been reported.

Please report any bugs or feature requests to
C<bug-narada@rt.cpan.org>, or through the web interface at
L<http://rt.cpan.org>.


=head1 AUTHOR

Alex Efros C<< <powerman@cpan.org> >>


=head1 LICENSE AND COPYRIGHT

This software is Copyright (c) 2008-2015 by Alex Efros E<lt>powerman@cpan.orgE<gt>.

This is free software, licensed under:

  The MIT (X11) License


=cut
